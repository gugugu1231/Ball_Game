<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>彩色球挑战</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            overflow: hidden;
            background-color: #f0f5ff;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            height: 100vh;
            width: 100vw;
            position: relative;
        }
        body::after {
            content: "咕咕";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 30vw;
            display: flex;
            justify-content: center;
            align-items: center;
            color: rgba(0,0,0,0.03);
            z-index: -1;
            pointer-events: none;
            font-weight: bold;
            font-family: 'Arial Black', sans-serif;
        }
        #gameContainer {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #player {
            position: absolute;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            border-radius: 50%;
            transition: transform 0.1s;
            z-index: 10;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.8);
            border: 2px solid white;
        }
        .ball {
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            border: 2px solid white;
            z-index: 8;
        }
        #targetDisplay {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            align-items: center;
            background-color: rgba(255,255,255,0.85);
            padding: 6px 12px;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            z-index: 50;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
            max-width: 80%;
        }
        #targetColor {
            width: 24px;
            height: 24px;
            border: 2px solid #2c3e50;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #targetText {
            font-size: 14px;
            font-weight: bold;
            color: #2c3e50;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #levelInfo {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 16px;
            color: #2c3e50;
            background-color: rgba(255,255,255,0.85);
            padding: 6px 12px;
            border-radius: 20px;
            z-index: 50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
            font-weight: bold;
        }
        #progressContainer {
            position: absolute;
            top: 60px;
            left: 15px;
            background-color: rgba(255,255,255,0.85);
            padding: 6px 12px;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            z-index: 50;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
            max-width: 80%;
        }
        #progressText {
            font-size: 14px;
            color: #2c3e50;
            font-weight: bold;
            white-space: nowrap;
        }
        #healthContainer {
            position: absolute;
            top: 60px;
            right: 15px;
            background-color: rgba(255,255,255,0.85);
            padding: 6px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            z-index: 50;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        #healthText {
            font-size: 14px;
            font-weight: bold;
            color: #2c3e50;
            margin-right: 8px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .health-point {
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-radius: 50%;
            margin-right: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .health-point:last-child {
            margin-right: 0;
        }
        .wall {
            position: absolute;
            background: linear-gradient(135deg, #7f8c8d, #6c7a7d);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 7;
        }
        .enemy {
            position: absolute;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-radius: 50%;
            z-index: 9;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.8);
            border: 2px solid white;
            transition: transform 0.2s;
        }
        .enemy.attacking {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.9);
        }
        .powerUp {
            position: absolute;
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            border-radius: 50%;
            animation: pulse 1s infinite;
            z-index: 9;
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.8);
            border: 2px solid white;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        #levelComplete {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 100;
            width: 85%;
            max-width: 350px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        #levelComplete h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #2ecc71;
        }
        #levelComplete p {
            font-size: 16px;
            margin-bottom: 20px;
        }
        #gameOver {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(231, 76, 60, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            text-align: center;
            padding: 20px;
        }
        #gameOver h1 {
            color: white;
            font-size: 2.2rem;
            margin-bottom: 20px;
            text-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        #gameOver p {
            color: white;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }
        #finalScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(46, 204, 113, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            text-align: center;
            padding: 20px;
        }
        #finalScreen h1 {
            color: white;
            font-size: 2.2rem;
            margin-bottom: 20px;
            text-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        #finalScreen p {
            color: white;
            font-size: 1.3rem;
            margin-bottom: 30px;
        }
        .button {
            padding: 12px 25px;
            font-size: 1rem;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
            font-weight: bold;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .button:hover {
            background: linear-gradient(135deg, #2980b9, #3498db);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        #helpButton {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(230, 230, 230, 0.9));
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            z-index: 50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: #2c3e50;
        }
        #helpModal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 150;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }
        #helpModal h2 {
            margin-bottom: 15px;
            color: #f1c40f;
            font-size: 20px;
            text-align: center;
        }
        #helpModal h3 {
            margin: 12px 0 8px;
            color: #3498db;
            font-size: 16px;
        }
        #helpModal p {
            margin-bottom: 10px;
            line-height: 1.5;
            font-size: 14px;
        }
        #helpModal ul {
            margin-left: 18px;
            margin-bottom: 15px;
        }
        #helpModal li {
            margin-bottom: 6px;
            line-height: 1.4;
            font-size: 14px;
        }
        #closeHelp {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .timer {
            position: absolute;
            top: 105px;
            left: 15px;
            font-size: 14px;
            color: #2c3e50;
            background-color: rgba(255,255,255,0.85);
            padding: 6px 12px;
            border-radius: 20px;
            z-index: 50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            font-weight: bold;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .special-ball {
            position: absolute;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            animation: rainbow 2s infinite linear;
            z-index: 9;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        @keyframes rainbow {
            0% { background-color: #e74c3c; }
            20% { background-color: #f1c40f; }
            40% { background-color: #2ecc71; }
            60% { background-color: #3498db; }
            80% { background-color: #9b59b6; }
            100% { background-color: #e74c3c; }
        }
        #player.shield {
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.9), 0 0 40px rgba(255, 255, 255, 0.8);
            animation: shieldEffect 2s infinite linear;
        }
        @keyframes shieldEffect {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        #player.speed {
            animation: speedEffect 0.5s infinite alternate;
        }
        @keyframes speedEffect {
            from { box-shadow: 0 0 15px rgba(52, 152, 219, 0.8); }
            to { box-shadow: 0 0 25px rgba(52, 152, 219, 0.9); }
        }
        .portal {
            position: absolute;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px dashed white;
            animation: spin 3s infinite linear;
            z-index: 9;
            box-shadow: 0 0 15px rgba(255,255,255,0.7);
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .damage-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(231, 76, 60, 0.4);
            display: none;
            pointer-events: none;
            z-index: 300;
        }
        .attack-indicator {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(231, 76, 60, 0.5);
            z-index: 8;
            animation: attackPulse 0.5s infinite alternate;
            display: none;
        }
        @keyframes attackPulse {
            from { transform: scale(1); opacity: 0.7; }
            to { transform: scale(1.3); opacity: 0.3; }
        }
        #scoreDisplay {
            position: absolute;
            top: 105px;
            right: 15px;
            font-size: 14px;
            color: #2c3e50;
            background-color: rgba(255,255,255,0.85);
            padding: 6px 12px;
            border-radius: 20px;
            z-index: 50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            font-weight: bold;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        #welcomeModal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 350px;
            z-index: 250;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        #welcomeModal h2 {
            margin-bottom: 15px;
            color: #f1c40f;
            font-size: 20px;
        }
        #welcomeModal p {
            margin-bottom: 15px;
            line-height: 1.5;
            font-size: 14px;
        }
        #startButton {
            padding: 10px 25px;
            font-size: 1rem;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
            font-weight: bold;
            border: 2px solid rgba(255,255,255,0.3);
        }
        #startButton:hover {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        #controlArea {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            z-index: 20;
            pointer-events: none;
            padding: 0 20px;
        }
        .control-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .control-row {
            display: flex;
            gap: 15px;
        }
        .control-btn {
            width: 60px;
            height: 60px;
            background-color: rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            pointer-events: auto;
            touch-action: manipulation;
            transition: all 0.2s;
        }
        .control-btn:active {
            background-color: rgba(52, 152, 219, 0.6);
            transform: scale(0.95);
        }
        .bomb {
            position: absolute;
            width: 25px;
            height: 25px;
            background-color: #333;
            border-radius: 50%;
            z-index: 9;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            border: 2px solid #e74c3c;
            animation: bombPulse 1s infinite;
        }
        @keyframes bombPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .explosion {
            position: absolute;
            width: 100px;
            height: 100px;
            background-color: rgba(231, 76, 60, 0.7);
            border-radius: 50%;
            z-index: 8;
            transform: scale(0);
            opacity: 1;
            pointer-events: none;
        }
        @media (min-width: 768px) {
            #controlArea {
                display: none;
            }
            #helpButton {
                bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="player"></div>
        
        <div id="targetDisplay">
            <div id="targetColor"></div>
            <div id="targetText">收集</div>
        </div>
        
        <div id="levelInfo">关卡: 1</div>
        
        <div id="progressContainer">
            <div id="progressText">0/5</div>
        </div>
        
        <div id="healthContainer">
            <div id="healthText">生命:</div>
            <div class="health-point"></div>
            <div class="health-point"></div>
            <div class="health-point"></div>
        </div>
        
        <div class="timer">时间: 0</div>
        <div id="scoreDisplay">得分: 0</div>
        
        <div id="helpButton">?</div>
        
        <div id="controlArea">
            <div class="control-column">
                <div class="control-btn" id="upBtn">↑</div>
                <div class="control-btn" id="downBtn">↓</div>
            </div>
            <div class="control-row">
                <div class="control-btn" id="leftBtn">←</div>
                <div class="control-btn" id="rightBtn">→</div>
            </div>
        </div>
        
        <div id="levelComplete">
            <h2>关卡完成!</h2>
            <p>准备进入下一关...</p>
        </div>
        
        <div id="gameOver">
            <h1>游戏结束!</h1>
            <p>你已到达关卡: <span id="finalLevel">1</span></p>
            <p>最终得分: <span id="finalScore1">0</span></p>
            <button class="button" id="restartButton1">重新开始</button>
        </div>
        
        <div id="finalScreen">
            <h1>恭喜通关!</h1>
            <p>你的最终得分: <span id="finalScore2">0</span></p>
            <button class="button" id="restartButton2">重新开始</button>
        </div>
        
        <div id="helpModal">
            <button id="closeHelp">×</button>
            <h2>游戏说明</h2>
            <p><strong>游戏目标：</strong>控制彩色圆点收集相同颜色的球，躲避敌人和炸弹</p>
            
            <h3>基本规则：</h3>
            <ul>
                <li>左上角显示当前需要收集的球颜色</li>
                <li>收集正确颜色的球增加进度</li>
                <li>收集错误颜色的球会减少生命值</li>
                <li>每关需要收集足够数量的球才能过关</li>
                <li>你有3条生命，用完游戏结束</li>
                <li>敌人会追踪并攻击你，小心躲避</li>
            </ul>
            
            <h3>游戏元素：</h3>
            <ul>
                <li><span style="color:var(--target)">彩色圆点</span> - 玩家角色(颜色与目标球相同)</li>
                <li><span style="color:var(--target)">目标颜色球</span> - 收集这些球来过关</li>
                <li><span style="color:var(--wrong)">其他颜色球</span> - 碰到会扣血</li>
                <li><span style="color:#7f8c8d">灰色方块</span> - 障碍墙，不能穿过</li>
                <li><span style="color:#e74c3c">红色圆点</span> - 敌人，会追踪并攻击你</li>
                <li><span style="color:#f1c40f">黄色闪光球</span> - 能量球，暂时获得特殊能力</li>
                <li><span style="color:rainbow">彩虹球</span> - 特殊球，收集后直接完成部分进度</li>
                <li><span style="color:black">黑色炸弹</span> - 碰到会爆炸并造成伤害</li>
                <li><span style="color:white">旋转传送门</span> - 传送到随机位置</li>
            </ul>
            
            <h3>特殊能力：</h3>
            <ul>
                <li><strong>护盾</strong> - 暂时无敌，可以穿过敌人和免疫伤害</li>
                <li><strong>加速</strong> - 移动速度大幅提升</li>
                <li><strong>磁铁</strong> - 自动吸引附近的目标球</li>
            </ul>
            
            <h3>操作方式：</h3>
            <ul>
                <li>电脑: 使用方向键(↑↓←→)或WASD移动</li>
                <li>手机: 使用屏幕下方的方向按钮</li>
            </ul>
            
            <p>随着关卡提升，难度会显著增加，需要更灵活的操作和策略。</p>
            <p>祝您游戏愉快!</p>
        </div>
        
        <div class="damage-effect" id="damageEffect"></div>
    </div>

    <div id="welcomeModal">
        <h2>欢迎来到彩色球挑战!</h2>
        <p>游戏目前为测试版本，如有bug请见谅</p>
        <p>我们会持续优化游戏体验</p>
        <button id="startButton">开始游戏</button>
    </div>

    <script>
        // 游戏变量
        const player = document.getElementById('player');
        const gameContainer = document.getElementById('gameContainer');
        const targetDisplay = document.getElementById('targetDisplay');
        const targetColor = document.getElementById('targetColor');
        const targetText = document.getElementById('targetText');
        const levelInfo = document.getElementById('levelInfo');
        const progressContainer = document.getElementById('progressContainer');
        const progressText = document.getElementById('progressText');
        const healthContainer = document.getElementById('healthContainer');
        const healthPoints = document.querySelectorAll('.health-point');
        const levelComplete = document.getElementById('levelComplete');
        const gameOverScreen = document.getElementById('gameOver');
        const finalScreen = document.getElementById('finalScreen');
        const restartButton1 = document.getElementById('restartButton1');
        const restartButton2 = document.getElementById('restartButton2');
        const helpButton = document.getElementById('helpButton');
        const helpModal = document.getElementById('helpModal');
        const closeHelp = document.getElementById('closeHelp');
        const timerDisplay = document.querySelector('.timer');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const finalScoreDisplay1 = document.getElementById('finalScore1');
        const finalScoreDisplay2 = document.getElementById('finalScore2');
        const finalLevelDisplay = document.getElementById('finalLevel');
        const damageEffect = document.getElementById('damageEffect');
        const welcomeModal = document.getElementById('welcomeModal');
        const startButton = document.getElementById('startButton');
        const upBtn = document.getElementById('upBtn');
        const downBtn = document.getElementById('downBtn');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        let gameLoopRunning = false;  // 新增这行
        let lastTime = 0;
        
        // 控制变量
        let playerX = 50;
        let playerY = 50;
        let score = 0;
        let currentLevel = 1;
        let requiredScore = 5;
        let health = 3;
        let balls = [];
        let walls = [];
        let enemies = [];
        let powerUps = [];
        let specialBalls = [];
        let portals = [];
        let bombs = [];
        let explosions = [];
        let attackIndicators = [];
        let colors = ['#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#1abc9c', '#e67e22'];
        let currentTargetColor = '';
        let gameWidth = window.innerWidth;
        let gameHeight = window.innerHeight;
        let keys = {};
        let gameTime = 0;
        let timerInterval;
        let playerSpeed = 5;
        let playerEffects = {
            shield: false,
            speed: false,
            magnet: false
        };
        let effectTimers = {};
        let totalScore = 0;
        let enemyAttackCooldown = 0;
        let gameStarted = false;
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // 颜色名称映射
        const colorNames = {
            '#e74c3c': '红色',
            '#2ecc71': '绿色',
            '#f1c40f': '黄色',
            '#9b59b6': '紫色',
            '#1abc9c': '青色',
            '#e67e22': '橙色'
        };
        
        // 初始化游戏
        function initGame() {
            playerX = gameWidth / 2;
            playerY = gameHeight / 2;
            score = 0;
            currentLevel = 1;
            health = 3;
            gameTime = 0;
            totalScore = 0;
            playerSpeed = 5;
            playerEffects = {
                shield: false,
                speed: false,
                magnet: false
            };

            // 重置游戏循环（新增这部分）
            lastTime = 0;
            if (!gameLoopRunning) {
            gameLoopRunning = true;
            requestAnimationFrame(gameLoop);
            }
            updatePlayerPosition();
            updateHealthDisplay();
            updateScoreDisplay();
            startLevel();
            startTimer();
            
            // 移除所有效果类
            player.className = '';
            
            // 重置按键状态
            keys = {
                ArrowUp: false,
                ArrowDown: false,
                ArrowLeft: false,
                ArrowRight: false,
                up: false,
                down: false,
                left: false,
                right: false
            };
            
            // 隐藏所有模态框
            welcomeModal.style.display = 'none';
            gameOverScreen.style.display = 'none';
            finalScreen.style.display = 'none';
            levelComplete.style.display = 'none';
        }
        
        // 更新生命值显示
        function updateHealthDisplay() {
            healthPoints.forEach((point, index) => {
                point.style.display = index < health ? 'block' : 'none';
            });
        }
        
        // 更新得分显示
        function updateScoreDisplay() {
            scoreDisplay.textContent = `得分: ${totalScore}`;
        }
        
        // 更新进度显示
        function updateProgressDisplay() {
            progressText.textContent = `${score}/${requiredScore}`;
        }
        
        // 受到伤害
        function takeDamage() {
            if (playerEffects.shield) return;
            
            health--;
            updateHealthDisplay();
            
            // 显示伤害效果
            damageEffect.style.display = 'block';
            setTimeout(() => {
                damageEffect.style.display = 'none';
            }, 300);
            
            // 检查游戏是否结束
            if (health <= 0) {
                gameOver();
            }
        }
        
        // 游戏结束
        function gameOver() {
            clearLevel();
            finalLevelDisplay.textContent = currentLevel;
            finalScoreDisplay1.textContent = totalScore;
            gameOverScreen.style.display = 'flex';
            clearInterval(timerInterval);
            gameStarted = false;
            gameLoopRunning = false;
        }
        
        // 开始计时器
        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                gameTime++;
                timerDisplay.textContent = `时间: ${gameTime}`;
            }, 1000);
        }
        
        // 开始新关卡
        function startLevel() {
            // 清除上一关的元素
            clearLevel();
            
            // 更新关卡信息
            levelInfo.textContent = `关卡: ${currentLevel}`;
            requiredScore = 5 + currentLevel * 2; // 每关增加2个需求
            score = 0; // 重置当前关卡得分
            updateProgressDisplay();
            
            // 设置目标颜色
            currentTargetColor = colors[Math.floor(Math.random() * colors.length)];
            targetColor.style.backgroundColor = currentTargetColor;
            player.style.background = `linear-gradient(135deg, ${currentTargetColor}, ${darkenColor(currentTargetColor, 20)})`;
            targetText.textContent = `收集${colorNames[currentTargetColor]}球`;
            
            // 创建游戏元素 - 确保至少有足够的目标球
            const totalBalls = 15 + currentLevel * 5;
            const targetBalls = Math.max(requiredScore, Math.floor(totalBalls * 0.4)); // 至少40%是目标球
            
            createBalls(totalBalls, targetBalls);
            
            // 从第二关开始添加墙
            if (currentLevel > 1) {
                createWalls(currentLevel + 2);
            }
            
            // 从第三关开始添加敌人
            if (currentLevel > 2) {
                createEnemies(Math.floor(currentLevel / 2) + 2);
            }
            
            // 从第四关开始添加能量球
            if (currentLevel > 3) {
                createPowerUps(2);
            }
            
            // 从第五关开始添加特殊球
            if (currentLevel > 4) {
                createSpecialBalls(1);
            }
            
            // 从第六关开始添加炸弹
            if (currentLevel > 5) {
                createBombs(1 + Math.floor(currentLevel / 3));
            }
            
            // 从第七关开始添加传送门
            if (currentLevel > 6) {
                createPortals(2);
            }
            
            // 调整玩家速度（随着关卡增加而变快）
            playerSpeed = 5 + currentLevel * 0.3;
            
            // 重置敌人攻击冷却
            enemyAttackCooldown = 0;
        }
        
        // 颜色变暗函数
        function darkenColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            return "#" + (
                0x1000000 +
                (R < 0 ? 0 : R) * 0x10000 +
                (G < 0 ? 0 : G) * 0x100 +
                (B < 0 ? 0 : B)
            ).toString(16).slice(1);
        }
        
        // 清除关卡元素
        function clearLevel() {
            balls.forEach(ball => ball.element.remove());
            walls.forEach(wall => wall.element.remove());
            enemies.forEach(enemy => enemy.element.remove());
            powerUps.forEach(powerUp => powerUp.element.remove());
            specialBalls.forEach(specialBall => specialBall.element.remove());
            bombs.forEach(bomb => bomb.element.remove());
            explosions.forEach(explosion => explosion.remove());
            portals.forEach(portal => portal.element.remove());
            attackIndicators.forEach(indicator => indicator.remove());
            
            balls = [];
            walls = [];
            enemies = [];
            powerUps = [];
            specialBalls = [];
            bombs = [];
            explosions = [];
            portals = [];
            attackIndicators = [];
        }

        // 创建球 - 确保有足够的目标球
        function createBalls(totalCount, targetCount) {
            // 先创建目标球
            for (let i = 0; i < targetCount; i++) {
                createBall(currentTargetColor);
            }
            
            // 然后创建其他颜色的球
            for (let i = targetCount; i < totalCount; i++) {
                const otherColors = colors.filter(c => c !== currentTargetColor);
                const color = otherColors[Math.floor(Math.random() * otherColors.length)];
                createBall(color);
            }
        }

        // 创建单个球
        function createBall(color) {
            const ball = document.createElement('div');
            ball.className = 'ball';
            
            // 随机位置（确保不会与玩家重叠）
            let x, y;
            do {
                x = Math.random() * (gameWidth - 40) + 20;
                y = Math.random() * (gameHeight - 40) + 20;
            } while (Math.abs(x - playerX) < 50 && Math.abs(y - playerY) < 50);
            
            ball.style.left = `${x}px`;
            ball.style.top = `${y}px`;
            ball.style.backgroundColor = color;
            
            gameContainer.appendChild(ball);
            
            balls.push({
                element: ball,
                x: x,
                y: y,
                color: color
            });
        }

        // 创建墙
        function createWalls(count) {
            for (let i = 0; i < count; i++) {
                const wall = document.createElement('div');
                wall.className = 'wall';
                
                // 随机位置和大小
                const isVertical = Math.random() < 0.5;
                const length = Math.random() * 100 + 50;
                const thickness = 15;
                
                const x = Math.random() * (gameWidth - length);
                const y = Math.random() * (gameHeight - length);
                
                wall.style.left = `${x}px`;
                wall.style.top = `${y}px`;
                
                if (isVertical) {
                    wall.style.width = `${thickness}px`;
                    wall.style.height = `${length}px`;
                } else {
                    wall.style.width = `${length}px`;
                    wall.style.height = `${thickness}px`;
                }
                
                gameContainer.appendChild(wall);
                
                walls.push({
                    element: wall,
                    x: x,
                    y: y,
                    width: isVertical ? thickness : length,
                    height: isVertical ? length : thickness
                });
            }
        }

        // 创建敌人
        function createEnemies(count) {
            for (let i = 0; i < count; i++) {
                const enemy = document.createElement('div');
                enemy.className = 'enemy';
                
                // 随机位置（确保不会与玩家重叠）
                let x, y;
                do {
                    x = Math.random() * (gameWidth - 40) + 20;
                    y = Math.random() * (gameHeight - 40) + 20;
                } while (Math.abs(x - playerX) < 100 && Math.abs(y - playerY) < 100);
                
                enemy.style.left = `${x}px`;
                enemy.style.top = `${y}px`;
                
                gameContainer.appendChild(enemy);
                
                enemies.push({
                    element: enemy,
                    x: x,
                    y: y,
                    attackTimer: Math.random() * 2000 + 1000
                });
            }
        }

        // 创建能量球
        function createPowerUps(count) {
            for (let i = 0; i < count; i++) {
                const powerUp = document.createElement('div');
                powerUp.className = 'powerUp';
                
                // 随机位置
                const x = Math.random() * (gameWidth - 40) + 20;
                const y = Math.random() * (gameHeight - 40) + 20;
                
                powerUp.style.left = `${x}px`;
                powerUp.style.top = `${y}px`;
                
                gameContainer.appendChild(powerUp);
                
                powerUps.push({
                    element: powerUp,
                    x: x,
                    y: y
                });
            }
        }

        // 创建特殊球
        function createSpecialBalls(count) {
            for (let i = 0; i < count; i++) {
                const specialBall = document.createElement('div');
                specialBall.className = 'special-ball';
                
                // 随机位置
                const x = Math.random() * (gameWidth - 40) + 20;
                const y = Math.random() * (gameHeight - 40) + 20;
                
                specialBall.style.left = `${x}px`;
                specialBall.style.top = `${y}px`;
                
                gameContainer.appendChild(specialBall);
                
                specialBalls.push({
                    element: specialBall,
                    x: x,
                    y: y
                });
            }
        }

        // 创建传送门
        function createPortals(count) {
            for (let i = 0; i < count; i++) {
                const portal = document.createElement('div');
                portal.className = 'portal';
                
                // 随机位置
                const x = Math.random() * (gameWidth - 60) + 30;
                const y = Math.random() * (gameHeight - 60) + 30;
                
                portal.style.left = `${x}px`;
                portal.style.top = `${y}px`;
                
                gameContainer.appendChild(portal);
                
                portals.push({
                    element: portal,
                    x: x,
                    y: y
                });
            }
        }

        // 创建炸弹
        function createBombs(count) {
            for (let i = 0; i < count; i++) {
                const bomb = document.createElement('div');
                bomb.className = 'bomb';
                
                // 随机位置
                const x = Math.random() * (gameWidth - 40) + 20;
                const y = Math.random() * (gameHeight - 40) + 20;
                
                bomb.style.left = `${x}px`;
                bomb.style.top = `${y}px`;
                
                gameContainer.appendChild(bomb);
                
                bombs.push({
                    element: bomb,
                    x: x,
                    y: y,
                    timer: Math.random() * 5000 + 5000 // 5-10秒后爆炸
                });
            }
        }

        // 创建爆炸效果
        function createExplosion(x, y) {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.left = `${x - 50}px`;
            explosion.style.top = `${y - 50}px`;
            gameContainer.appendChild(explosion);
            explosions.push(explosion);
            
            // 爆炸动画
            let scale = 0;
            const explosionInterval = setInterval(() => {
                scale += 0.1;
                explosion.style.transform = `scale(${scale})`;
                explosion.style.opacity = 1 - scale * 0.1;
                
                if (scale >= 10) {
                    clearInterval(explosionInterval);
                    explosion.remove();
                    explosions = explosions.filter(e => e !== explosion);
                }
                
                // 检测玩家是否在爆炸范围内
                const dx = playerX - x;
                const dy = playerY - y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 50 + scale * 5 && !playerEffects.shield) {
                    takeDamage();
                }
            }, 30);
        }

        // 更新玩家位置
        function updatePlayerPosition() {
            player.style.left = `${playerX}px`;
            player.style.top = `${playerY}px`;
        }

        // 应用效果
        function applyEffect(type, duration) {
            playerEffects[type] = true;
            
            // 添加效果类
            if (type === 'shield') player.classList.add('shield');
            if (type === 'speed') player.classList.add('speed');
            
            // 清除之前的计时器（如果存在）
            if (effectTimers[type]) {
                clearTimeout(effectTimers[type]);
            }
            
            // 设置效果持续时间
            effectTimers[type] = setTimeout(() => {
                playerEffects[type] = false;
                
                // 移除效果类
                if (type === 'shield') player.classList.remove('shield');
                if (type === 'speed') player.classList.remove('speed');
            }, duration);
        }

        // 磁铁效果
        function magnetEffect() {
            if (!playerEffects.magnet) return;
            
            balls.forEach(ball => {
                if (ball.color === currentTargetColor) {
                    const dx = playerX - ball.x;
                    const dy = playerY - ball.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 200) { // 吸引范围
                        const speed = 3;
                        const vx = (dx / distance) * speed;
                        const vy = (dy / distance) * speed;
                        
                        ball.x += vx;
                        ball.y += vy;
                        ball.element.style.left = `${ball.x}px`;
                        ball.element.style.top = `${ball.y}px`;
                    }
                }
            });
        }

        // 检测碰撞
        function checkCollisions() {
            // 检测球碰撞
            for (let i = balls.length - 1; i >= 0; i--) {
                const ball = balls[i];
                const dx = playerX - ball.x;
                const dy = playerY - ball.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 25) { // 碰撞距离
                    if (ball.color === currentTargetColor) {
                        // 收集正确颜色的球
                        score++;
                        totalScore += currentLevel * 15; // 关卡越高得分越高
                        updateProgressDisplay();
                        updateScoreDisplay();
                        
                        // 检查是否完成关卡
                        if (score >= requiredScore) {
                            completeLevel();
                            return;
                        }
                    } else {
                        // 收集错误颜色的球扣血
                        takeDamage();
                    }
                    
                    // 移除球
                    ball.element.remove();
                    balls.splice(i, 1);
                    
                    // 创建新球
                    createBall(Math.random() < 0.25 ? currentTargetColor : 
                        colors.filter(c => c !== currentTargetColor)[Math.floor(Math.random() * (colors.length - 1))]);
                }
            }
            
            // 检测能量球碰撞
            for (let i = powerUps.length - 1; i >= 0; i--) {
                const powerUp = powerUps[i];
                const dx = playerX - powerUp.x;
                const dy = playerY - powerUp.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 25) {
                    // 随机获得一种能力
                    const effects = ['shield', 'speed', 'magnet'];
                    const effect = effects[Math.floor(Math.random() * effects.length)];
                    applyEffect(effect, 5000); // 持续5秒
                    
                    powerUp.element.remove();
                    powerUps.splice(i, 1);
                    
                    // 创建新能量球
                    setTimeout(() => {
                        createPowerUps(1);
                    }, 10000);
                }
            }
            
            // 检测特殊球碰撞
            for (let i = specialBalls.length - 1; i >= 0; i--) {
                const specialBall = specialBalls[i];
                const dx = playerX - specialBall.x;
                const dy = playerY - specialBall.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 25) {
                    // 直接增加进度
                    score += 2;
                    totalScore += currentLevel * 30;
                    updateProgressDisplay();
                    updateScoreDisplay();
                    
                    // 检查是否完成关卡
                    if (score >= requiredScore) {
                        completeLevel();
                        return;
                    }
                    
                    specialBall.element.remove();
                    specialBalls.splice(i, 1);
                    
                    // 创建新特殊球
                    setTimeout(() => {
                        createSpecialBalls(1);
                    }, 15000);
                }
            }
            
            // 检测炸弹碰撞
            for (let i = bombs.length - 1; i >= 0; i--) {
                const bomb = bombs[i];
                const dx = playerX - bomb.x;
                const dy = playerY - bomb.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 25) { // 碰撞距离
                    // 立即引爆炸弹
                    createExplosion(bomb.x, bomb.y);
                    bomb.element.remove();
                    bombs.splice(i, 1);
                    
                    // 创建新炸弹
                    setTimeout(() => {
                        createBombs(1);
                    }, 10000);
                }
            }
            
            // 检测传送门碰撞
            for (let i = portals.length - 1; i >= 0; i--) {
                const portal = portals[i];
                const dx = playerX - portal.x;
                const dy = playerY - portal.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 30) {
                    // 传送到随机位置
                    playerX = Math.random() * (gameWidth - 40) + 20;
                    playerY = Math.random() * (gameHeight - 40) + 20;
                    updatePlayerPosition();
                    break;
                }
            }
            
            // 检测墙碰撞
            for (let i = 0; i < walls.length; i++) {
            const wall = walls[i];
        
        // 更精确的矩形碰撞检测
            if (playerX + 16 > wall.x && 
                playerX - 16 < wall.x + wall.width && 
                playerY + 16 > wall.y && 
                playerY - 16 < wall.y + wall.height) {
            
            // 计算玩家到墙中心的向量
            const wallCenterX = wall.x + wall.width / 2;
            const wallCenterY = wall.y + wall.height / 2;
            const dx = playerX - wallCenterX;
            const dy = playerY - wallCenterY;
            
            // 确定从哪个方向推出玩家
            if (Math.abs(dx) > Math.abs(dy)) {
                // 水平方向推出
                if (dx > 0) {
                    playerX = wall.x + wall.width + 16;
                } else {
                    playerX = wall.x - 16;
                }
            } else {
                // 垂直方向推出
                if (dy > 0) {
                    playerY = wall.y + wall.height + 16;
                } else {
                    playerY = wall.y - 16;
                }
            }
            updatePlayerPosition();
        }
    }
            
            // 检测敌人碰撞
            for (let i = 0; i < enemies.length; i++) {
                const enemy = enemies[i];
                const dx = playerX - enemy.x;
                const dy = playerY - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 30 && !playerEffects.shield) {
                    // 敌人攻击
                    if (enemyAttackCooldown <= 0) {
                        takeDamage();
                        enemyAttackCooldown = 1000; // 攻击冷却1秒
                        
                        // 显示攻击指示器
                        const indicator = document.createElement('div');
                        indicator.className = 'attack-indicator';
                        indicator.style.left = `${enemy.x - 20}px`;
                        indicator.style.top = `${enemy.y - 20}px`;
                        gameContainer.appendChild(indicator);
                        attackIndicators.push(indicator);
                        
                        setTimeout(() => {
                            indicator.remove();
                            attackIndicators = attackIndicators.filter(i => i !== indicator);
                        }, 500);
                    }
                }
            }
        }

        // 移动敌人
        function moveEnemies(deltaTime) {
            enemyAttackCooldown -= deltaTime;
            
            enemies.forEach((enemy, index) => {
                // 敌人追踪玩家
                const dx = playerX - enemy.x;
                const dy = playerY - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 0) {
                    const speed = 0.9 + currentLevel * 0.1; // 敌人速度随关卡增加
                    const vx = (dx / distance) * speed;
                    const vy = (dy / distance) * speed;
                    
                    enemy.x += vx;
                    enemy.y += vy;
                    
                    enemy.element.style.left = `${enemy.x}px`;
                    enemy.element.style.top = `${enemy.y}px`;
                    
                    // 敌人攻击动画
                    enemy.attackTimer -= deltaTime;
                    if (enemy.attackTimer <= 0) {
                        enemy.element.classList.add('attacking');
                        enemy.attackTimer = Math.random() * 2000 + 1000;
                        
                        setTimeout(() => {
                            enemy.element.classList.remove('attacking');
                        }, 300);
                    }
                }
            });
            
            // 更新炸弹计时器
            bombs.forEach(bomb => {
                bomb.timer -= deltaTime;
                if (bomb.timer <= 0) {
                    createExplosion(bomb.x, bomb.y);
                    bomb.element.remove();
                    bombs = bombs.filter(b => b !== bomb);
                    
                    // 创建新炸弹
                    setTimeout(() => {
                        createBombs(1);
                    }, 10000);
                }
            });
        }

        // 完成关卡
        function completeLevel() {
            clearLevel();
            levelComplete.style.display = 'block';
            
            setTimeout(() => {
                levelComplete.style.display = 'none';
                currentLevel++;
                
                if (currentLevel <= 15) { // 总共15关
                    startLevel();
                } else {
                    // 游戏完成
                    finalScoreDisplay2.textContent = totalScore;
                    finalScreen.style.display = 'flex';
                    clearInterval(timerInterval);
                    gameStarted = false;
                }
            }, 1500);
        }

        // 键盘控制
        window.addEventListener('keydown', (e) => {
            if (!gameStarted) return;
            if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') keys.ArrowUp = true;
            if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') keys.ArrowDown = true;
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') keys.ArrowLeft = true;
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') keys.ArrowRight = true;
        });
        
        window.addEventListener('keyup', (e) => {
            if (!gameStarted) return;
            if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') keys.ArrowUp = false;
            if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') keys.ArrowDown = false;
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') keys.ArrowLeft = false;
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') keys.ArrowRight = false;
        });

        // 手机方向按钮控制
        upBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            keys.up = true;
        });
        upBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            keys.up = false;
        });
        
        downBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            keys.down = true;
        });
        downBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            keys.down = false;
        });
        
        leftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            keys.left = true;
        });
        leftBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            keys.left = false;
        });
        
        rightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            keys.right = true;
        });
        rightBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            keys.right = false;
        });

        // 游戏说明
        helpButton.addEventListener('click', () => {
            helpModal.style.display = 'block';
        });
        
        closeHelp.addEventListener('click', () => {
            helpModal.style.display = 'none';
        });

        // 重新开始按钮
        restartButton1.addEventListener('click', (e) => {
            e.preventDefault();
            gameOverScreen.style.display = 'none';
            gameStarted = true;
            initGame();
        // 确保游戏循环启动
        if (!gameLoopRunning) {
        gameLoopRunning = true;
        lastTime = performance.now();
        requestAnimationFrame(gameLoop);
        }
        });
        
        restartButton2.addEventListener('click', (e) => {
            e.preventDefault();
            finalScreen.style.display = 'none';
            gameStarted = true;
            initGame();
         // 确保游戏循环启动
        if (!gameLoopRunning) {
        gameLoopRunning = true;
        lastTime = performance.now();
        requestAnimationFrame(gameLoop);
        }
        });

        // 开始游戏按钮
        startButton.addEventListener('click', () => {
            welcomeModal.style.display = 'none';
            gameStarted = true;
            initGame();
        });

        // 游戏循环
        let lastTime = 0;
        function gameLoop(timestamp) {
            if (!gameStarted) {
                gameLoopRunning = false; //新增这行
                requestAnimationFrame(gameLoop);
                return;
            }
            
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            
            // 移动玩家
            if ((keys.ArrowUp || keys.up) && playerY > 15) playerY -= playerSpeed;
            if ((keys.ArrowDown || keys.down) && playerY < gameHeight - 15) playerY += playerSpeed;
            if ((keys.ArrowLeft || keys.left) && playerX > 15) playerX -= playerSpeed;
            if ((keys.ArrowRight || keys.right) && playerX < gameWidth - 15) playerX += playerSpeed;
            
            updatePlayerPosition();
            checkCollisions();
            magnetEffect();
            moveEnemies(deltaTime);

            if (gameStarted) {  // 修改这行
            requestAnimationFrame(gameLoop)
            }else {
                gameLoopRunning = false; // 新增这行;
            }
        }

        // 初始化游戏循环
        requestAnimationFrame(gameLoop);

        // 窗口大小调整
        window.addEventListener('resize', () => {
            gameWidth = window.innerWidth;
            gameHeight = window.innerHeight;
        });

        // 显示欢迎界面
        welcomeModal.style.display = 'block';
    </script>
</body>
</html>
