<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>终极彩色球挑战</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            touch-action: manipulation;
        }
        body {
            overflow: hidden;
            background-color: #f0f5ff;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            height: 100vh;
            width: 100vw;
            position: relative;
        }
        body::after {
            content: "咕咕";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 30vw;
            display: flex;
            justify-content: center;
            align-items: center;
            color: rgba(0,0,0,0.03);
            z-index: -1;
            pointer-events: none;
            font-weight: bold;
            font-family: 'Arial Black', sans-serif;
        }
        #gameContainer {
            position: relative;
            width: 100%;
            height: 100%;
        }
        #player {
            position: absolute;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 50%;
            transition: transform 0.1s;
            z-index: 10;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.8);
            border: 2px solid white;
        }
        .ball {
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            border: 2px solid white;
            z-index: 8; /* 确保球在UI下方 */
        }
        #targetDisplay {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            background-color: rgba(255,255,255,0.85);
            padding: 8px 15px;
            border-radius: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            z-index: 50;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        #targetColor {
            width: 28px;
            height: 28px;
            border: 2px solid #2c3e50;
            border-radius: 50%;
            margin-right: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #targetText {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        #levelInfo {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            color: #2c3e50;
            background-color: rgba(255,255,255,0.85);
            padding: 8px 20px;
            border-radius: 25px;
            z-index: 50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
            font-weight: bold;
        }
        #progressContainer {
            position: absolute;
            top: 70px;
            left: 20px;
            width: calc(100% - 40px);
            max-width: 450px;
            background-color: rgba(255,255,255,0.85);
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            z-index: 50;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        #progressText {
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 5px;
            text-align: center;
            font-weight: bold;
        }
        #progressBar {
            width: 100%;
            height: 18px;
            background-color: #ecf0f1;
            border-radius: 9px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        #progress {
            height: 100%;
            background: linear-gradient(to right, #2ecc71, #27ae60);
            width: 0%;
            transition: width 0.3s;
            border-radius: 9px;
        }
        #healthContainer {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(255,255,255,0.85);
            padding: 8px 15px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            z-index: 50;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        #healthText {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-right: 10px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .health-point {
            width: 14px;
            height: 14px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-radius: 50%;
            margin-right: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .health-point:last-child {
            margin-right: 0;
        }
        .wall {
            position: absolute;
            background: linear-gradient(135deg, #7f8c8d, #6c7a7d);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 7;
        }
        .enemy {
            position: absolute;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-radius: 50%;
            z-index: 9;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.8);
            border: 2px solid white;
            transition: transform 0.2s;
        }
        .enemy.attacking {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.9);
        }
        .powerUp {
            position: absolute;
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            border-radius: 50%;
            animation: pulse 1s infinite;
            z-index: 9;
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.8);
            border: 2px solid white;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        #levelComplete {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 100;
            width: 85%;
            max-width: 450px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        #levelComplete h2 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #2ecc71;
        }
        #levelComplete p {
            font-size: 18px;
            margin-bottom: 20px;
        }
        #gameOver {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(231, 76, 60, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            text-align: center;
            padding: 20px;
        }
        #gameOver h1 {
            color: white;
            font-size: 2.8rem;
            margin-bottom: 20px;
            text-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        #gameOver p {
            color: white;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }
        #finalScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(46, 204, 113, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            text-align: center;
            padding: 20px;
        }
        #finalScreen h1 {
            color: white;
            font-size: 2.8rem;
            margin-bottom: 20px;
            text-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        #finalScreen p {
            color: white;
            font-size: 1.5rem;
            margin-bottom: 30px;
        }
        .button {
            padding: 15px 35px;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            transition: all 0.3s;
            font-weight: bold;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .button:hover {
            background: linear-gradient(135deg, #2980b9, #3498db);
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.3);
        }
        #controls {
            position: absolute;
            bottom: 25px;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 50;
        }
        .control-btn {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.8), rgba(41, 128, 185, 0.8));
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 12px;
            color: white;
            font-size: 28px;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.2s;
        }
        .control-btn:active {
            transform: scale(0.95);
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        #helpButton {
            position: absolute;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(230, 230, 230, 0.9));
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            z-index: 50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: #2c3e50;
        }
        #helpModal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 150;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }
        #helpModal h2 {
            margin-bottom: 20px;
            color: #f1c40f;
            font-size: 24px;
            text-align: center;
        }
        #helpModal h3 {
            margin: 15px 0 10px;
            color: #3498db;
            font-size: 18px;
        }
        #helpModal p {
            margin-bottom: 12px;
            line-height: 1.6;
            font-size: 16px;
        }
        #helpModal ul {
            margin-left: 20px;
            margin-bottom: 20px;
        }
        #helpModal li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        #closeHelp {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .timer {
            position: absolute;
            top: 110px;
            left: 20px;
            font-size: 16px;
            color: #2c3e50;
            background-color: rgba(255,255,255,0.85);
            padding: 8px 15px;
            border-radius: 25px;
            z-index: 50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            font-weight: bold;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .special-ball {
            position: absolute;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            animation: rainbow 2s infinite linear;
            z-index: 9;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        @keyframes rainbow {
            0% { background-color: #e74c3c; }
            20% { background-color: #f1c40f; }
            40% { background-color: #2ecc71; }
            60% { background-color: #3498db; }
            80% { background-color: #9b59b6; }
            100% { background-color: #e74c3c; }
        }
        #player.shield {
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.9), 0 0 40px rgba(255, 255, 255, 0.8);
            animation: shieldEffect 2s infinite linear;
        }
        @keyframes shieldEffect {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        #player.speed {
            animation: speedEffect 0.5s infinite alternate;
        }
        @keyframes speedEffect {
            from { box-shadow: 0 0 15px rgba(52, 152, 219, 0.8); }
            to { box-shadow: 0 0 25px rgba(52, 152, 219, 0.9); }
        }
        .portal {
            position: absolute;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px dashed white;
            animation: spin 3s infinite linear;
            z-index: 9;
            box-shadow: 0 0 15px rgba(255,255,255,0.7);
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .damage-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(231, 76, 60, 0.4);
            display: none;
            pointer-events: none;
            z-index: 300;
        }
        .attack-indicator {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(231, 76, 60, 0.5);
            z-index: 8;
            animation: attackPulse 0.5s infinite alternate;
            display: none;
        }
        @keyframes attackPulse {
            from { transform: scale(1); opacity: 0.7; }
            to { transform: scale(1.3); opacity: 0.3; }
        }
        #scoreDisplay {
            position: absolute;
            top: 150px;
            left: 20px;
            font-size: 16px;
            color: #2c3e50;
            background-color: rgba(255,255,255,0.85);
            padding: 8px 15px;
            border-radius: 25px;
            z-index: 50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            font-weight: bold;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        #welcomeModal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            z-index: 250;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        #welcomeModal h2 {
            margin-bottom: 20px;
            color: #f1c40f;
            font-size: 24px;
        }
        #welcomeModal p {
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 16px;
        }
        #startButton {
            padding: 12px 30px;
            font-size: 1.1rem;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
            font-weight: bold;
            border: 2px solid rgba(255,255,255,0.3);
        }
        #startButton:hover {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="player"></div>
        
        <div id="targetDisplay">
            <div id="targetColor"></div>
            <div id="targetText">收集</div>
        </div>
        
        <div id="levelInfo">关卡: 1</div>
        
        <div id="progressContainer">
            <div id="progressText">0 / 5</div>
            <div id="progressBar"><div id="progress"></div></div>
        </div>
        
        <div id="healthContainer">
            <div id="healthText">生命:</div>
            <div class="health-point"></div>
            <div class="health-point"></div>
            <div class="health-point"></div>
        </div>
        
        <div class="timer">时间: 0</div>
        <div id="scoreDisplay">得分: 0</div>
        
        <div id="helpButton">?</div>
        
        <div id="controls">
            <div class="control-btn" id="up">↑</div>
            <div class="control-btn" id="left">←</div>
            <div class="control-btn" id="down">↓</div>
            <div class="control-btn" id="right">→</div>
        </div>
        
        <div id="levelComplete">
            <h2>关卡完成!</h2>
            <p>准备进入下一关...</p>
        </div>
        
        <div id="gameOver">
            <h1>游戏结束!</h1>
            <p>你已到达关卡: <span id="finalLevel">1</span></p>
            <p>最终得分: <span id="finalScore1">0</span></p>
            <button class="button" id="restartButton1">重新开始</button>
        </div>
        
        <div id="finalScreen">
            <h1>恭喜通关!</h1>
            <p>你的最终得分: <span id="finalScore2">0</span></p>
            <button class="button" id="restartButton2">重新开始</button>
        </div>
        
        <div id="helpModal">
            <button id="closeHelp">×</button>
            <h2>游戏说明</h2>
            <p><strong>游戏目标：</strong>控制蓝色圆点收集指定颜色的彩色球，同时躲避敌人攻击</p>
            
            <h3>基本规则：</h3>
            <ul>
                <li>左上角显示当前需要收集的球颜色</li>
                <li>收集正确颜色的球增加进度</li>
                <li>收集错误颜色的球会减少生命值</li>
                <li>每关需要收集足够数量的球才能过关</li>
                <li>你有3条生命，用完游戏结束</li>
                <li>敌人会追踪并攻击你，小心躲避</li>
            </ul>
            
            <h3>游戏元素：</h3>
            <ul>
                <li><span style="color:#3498db">蓝色圆点</span> - 玩家角色</li>
                <li><span style="color:var(--target)">目标颜色球</span> - 收集这些球来过关</li>
                <li><span style="color:var(--wrong)">其他颜色球</span> - 碰到会扣血</li>
                <li><span style="color:#7f8c8d">灰色方块</span> - 障碍墙，不能穿过</li>
                <li><span style="color:#e74c3c">红色圆点</span> - 敌人，会追踪并攻击你</li>
                <li><span style="color:#f1c40f">黄色闪光球</span> - 能量球，暂时获得特殊能力</li>
                <li><span style="color:rainbow">彩虹球</span> - 特殊球，收集后直接完成部分进度</li>
                <li><span style="color:white">旋转传送门</span> - 传送到随机位置</li>
            </ul>
            
            <h3>特殊能力：</h3>
            <ul>
                <li><strong>护盾</strong> - 暂时无敌，可以穿过敌人和免疫伤害</li>
                <li><strong>加速</strong> - 移动速度大幅提升</li>
                <li><strong>磁铁</strong> - 自动吸引附近的目标球</li>
            </ul>
            
            <h3>敌人行为：</h3>
            <ul>
                <li>敌人会追踪玩家位置</li>
                <li>定期发动攻击，攻击前会有红色闪烁提示</li>
                <li>被敌人攻击到会减速并损失生命值</li>
                <li>关卡越高敌人数量和攻击频率越高</li>
            </ul>
            
            <p>随着关卡提升，难度会显著增加，需要更灵活的操作和策略。</p>
            <p>祝您游戏愉快!</p>
        </div>
        
        <div class="damage-effect" id="damageEffect"></div>
    </div>

    <div id="welcomeModal">
        <h2>欢迎来到彩色球挑战!</h2>
        <p>游戏目前为内测版本，如有bug请见谅</p>
        <p>我们会持续优化游戏体验</p>
        <button id="startButton">开始游戏</button>
    </div>

    <script>
        // 游戏变量
        const player = document.getElementById('player');
        const gameContainer = document.getElementById('gameContainer');
        const targetDisplay = document.getElementById('targetDisplay');
        const targetColor = document.getElementById('targetColor');
        const targetText = document.getElementById('targetText');
        const levelInfo = document.getElementById('levelInfo');
        const progressContainer = document.getElementById('progressContainer');
        const progressText = document.getElementById('progressText');
        const progressBar = document.getElementById('progress');
        const healthContainer = document.getElementById('healthContainer');
        const healthPoints = document.querySelectorAll('.health-point');
        const levelComplete = document.getElementById('levelComplete');
        const gameOverScreen = document.getElementById('gameOver');
        const finalScreen = document.getElementById('finalScreen');
        const restartButton1 = document.getElementById('restartButton1');
        const restartButton2 = document.getElementById('restartButton2');
        const helpButton = document.getElementById('helpButton');
        const helpModal = document.getElementById('helpModal');
        const closeHelp = document.getElementById('closeHelp');
        const timerDisplay = document.querySelector('.timer');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const finalScoreDisplay1 = document.getElementById('finalScore1');
        const finalScoreDisplay2 = document.getElementById('finalScore2');
        const finalLevelDisplay = document.getElementById('finalLevel');
        const damageEffect = document.getElementById('damageEffect');
        const welcomeModal = document.getElementById('welcomeModal');
        const startButton = document.getElementById('startButton');
        
        // 控制按钮
        const upBtn = document.getElementById('up');
        const leftBtn = document.getElementById('left');
        const downBtn = document.getElementById('down');
        const rightBtn = document.getElementById('right');
        
        let playerX = 50;
        let playerY = 50;
        let score = 0;
        let currentLevel = 1;
        let requiredScore = 5;
        let health = 3;
        let balls = [];
        let walls = [];
        let enemies = [];
        let powerUps = [];
        let specialBalls = [];
        let portals = [];
        let attackIndicators = [];
        let colors = ['#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#1abc9c', '#e67e22'];
        let currentTargetColor = '';
        let gameWidth = window.innerWidth;
        let gameHeight = window.innerHeight;
        let keys = {};
        let gameTime = 0;
        let timerInterval;
        let playerSpeed = 5;
        let playerEffects = {
            shield: false,
            speed: false,
            magnet: false
        };
        let effectTimers = {};
        let totalScore = 0;
        let enemyAttackCooldown = 0;
        let gameStarted = false;
        
        // 颜色名称映射
        const colorNames = {
            '#e74c3c': '红色',
            '#2ecc71': '绿色',
            '#f1c40f': '黄色',
            '#9b59b6': '紫色',
            '#1abc9c': '青色',
            '#e67e22': '橙色'
        };
        
        // 初始化游戏
        function initGame() {
            playerX = gameWidth / 2;
            playerY = gameHeight / 2;
            score = 0;
            currentLevel = 1;
            health = 3;
            gameTime = 0;
            totalScore = 0;
            playerSpeed = 5;
            playerEffects = {
                shield: false,
                speed: false,
                magnet: false
            };
            
            updatePlayerPosition();
            updateHealthDisplay();
            updateScoreDisplay();
            startLevel();
            startTimer();
            
            // 移除所有效果类
            player.className = '';
            
            // 重置按键状态
            keys = {
                ArrowUp: false,
                ArrowDown: false,
                ArrowLeft: false,
                ArrowRight: false,
                up: false,
                down: false,
                left: false,
                right: false
            };
        }
        
        // 更新生命值显示
        function updateHealthDisplay() {
            healthPoints.forEach((point, index) => {
                point.style.display = index < health ? 'block' : 'none';
            });
        }
        
        // 更新得分显示
        function updateScoreDisplay() {
            scoreDisplay.textContent = `得分: ${totalScore}`;
        }
        
        // 受到伤害
        function takeDamage() {
            if (playerEffects.shield) return;
            
            health--;
            updateHealthDisplay();
            
            // 显示伤害效果
            damageEffect.style.display = 'block';
            setTimeout(() => {
                damageEffect.style.display = 'none';
            }, 300);
            
            // 检查游戏是否结束
            if (health <= 0) {
                gameOver();
            }
        }
        
        // 游戏结束
        function gameOver() {
            clearLevel();
            finalLevelDisplay.textContent = currentLevel;
            finalScoreDisplay1.textContent = totalScore;
            gameOverScreen.style.display = 'flex';
            clearInterval(timerInterval);
        }
        
        // 开始计时器
        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                gameTime++;
                timerDisplay.textContent = `时间: ${gameTime}`;
                
                // 每秒钟增加1分
                totalScore++;
                updateScoreDisplay();
            }, 1000);
        }
        
        // 开始新关卡
        function startLevel() {
            // 清除上一关的元素
            clearLevel();
            
            // 更新关卡信息
            levelInfo.textContent = `关卡: ${currentLevel}`;
            requiredScore = 5 + currentLevel * 2; // 每关增加2个需求
            score = 0; // 重置当前关卡得分
            progressText.textContent = `0 / ${requiredScore}`;
            progressBar.style.width = '0%';
            
            // 设置目标颜色
            currentTargetColor = colors[Math.floor(Math.random() * colors.length)];
            targetColor.style.backgroundColor = currentTargetColor;
            targetText.textContent = `收集${colorNames[currentTargetColor]}球`;
            
            // 创建游戏元素
            createBalls(15 + currentLevel * 5); // 更多球
            
            // 从第二关开始添加墙
            if (currentLevel > 1) {
                createWalls(currentLevel + 2);
            }
            
            // 从第三关开始添加敌人
            if (currentLevel > 2) {
                createEnemies(Math.floor(currentLevel / 2) + 2);
            }
            
            // 从第四关开始添加能量球
            if (currentLevel > 3) {
                createPowerUps(2);
            }
            
            // 从第五关开始添加特殊球
            if (currentLevel > 4) {
                createSpecialBalls(1);
            }
            
            // 从第六关开始添加传送门
            if (currentLevel > 5) {
                createPortals(2);
            }
            
            // 调整玩家速度（随着关卡增加而变快）
            playerSpeed = 5 + currentLevel * 0.3;
            
            // 重置敌人攻击冷却
            enemyAttackCooldown = 0;
        }
        
        // 清除关卡元素
        function clearLevel() {
            balls.forEach(ball => ball.element.remove());
            walls.forEach(wall => wall.element.remove());
            enemies.forEach(enemy => enemy.element.remove());
            powerUps.forEach(powerUp => powerUp.element.remove());
            specialBalls.forEach(specialBall => specialBall.element.remove());
            portals.forEach(portal => portal.element.remove());
            attackIndicators.forEach(indicator => indicator.remove());
            
            balls = [];
            walls = [];
            enemies = [];
            powerUps = [];
            specialBalls = [];
            portals = [];
            attackIndicators = [];
        }
        
        // 创建球
        function createBalls(count) {
            for (let i = 0; i < count; i++) {
                const ball = document.createElement('div');
                ball.className = 'ball';
                
                // 随机位置（确保不会与玩家重叠）
                let x, y;
                do {
                    x = Math.random() * (gameWidth - 40) + 20;
                    y = Math.random() * (gameHeight - 40) + 20;
                } while (Math.abs(x - playerX) < 50 && Math.abs(y - playerY) < 50);
                
                // 随机颜色（有一定概率是目标颜色）
                const isTarget = Math.random() < 0.25;
                const color = isTarget ? currentTargetColor : 
                    colors.filter(c => c !== currentTargetColor)[Math.floor(Math.random() * (colors.length - 1))];
                
                ball.style.left = `${x}px`;
                ball.style.top = `${y}px`;
                ball.style.backgroundColor = color;
                
                gameContainer.appendChild(ball);
                
                balls.push({
                    element: ball,
                    x: x,
                    y: y,
                    color: color
                });
            }
        }
        
        // 创建墙
        function createWalls(count) {
            for (let i = 0; i < count; i++) {
                const wall = document.createElement('div');
                wall.className = 'wall';
                
                // 随机位置和大小
                const isVertical = Math.random() < 0.5;
                const x = Math.random() * (gameWidth - 100) + 50;
                const y = Math.random() * (gameHeight - 100) + 50;
                const width = isVertical ? 20 : Math.random() * 200 + 50;
                const height = isVertical ? Math.random() * 200 + 50 : 20;
                
                wall.style.left = `${x}px`;
                wall.style.top = `${y}px`;
                wall.style.width = `${width}px`;
                wall.style.height = `${height}px`;
                
                gameContainer.appendChild(wall);
                
                walls.push({
                    element: wall,
                    x: x,
                    y: y,
                    width: width,
                    height: height
                });
            }
        }
        
        // 创建敌人
        function createEnemies(count) {
            for (let i = 0; i < count; i++) {
                const enemy = document.createElement('div');
                enemy.className = 'enemy';
                
                // 随机位置（确保不会与玩家重叠）
                let x, y;
                do {
                    x = Math.random() * (gameWidth - 40) + 20;
                    y = Math.random() * (gameHeight - 40) + 20;
                } while (Math.abs(x - playerX) < 100 && Math.abs(y - playerY) < 100);
                
                enemy.style.left = `${x}px`;
                enemy.style.top = `${y}px`;
                
                gameContainer.appendChild(enemy);
                
                enemies.push({
                    element: enemy,
                    x: x,
                    y: y,
                    speedX: Math.random() * 2 - 1,
                    speedY: Math.random() * 2 - 1,
                    attackTimer: Math.random() * 2000 + 1000, // 随机攻击间隔
                    isAttacking: false,
                    attackCooldown: 0
                });
                
                // 创建攻击指示器
                const indicator = document.createElement('div');
                indicator.className = 'attack-indicator';
                indicator.style.display = 'none';
                gameContainer.appendChild(indicator);
                attackIndicators.push(indicator);
            }
        }
        
        // 创建能量球
        function createPowerUps(count) {
            for (let i = 0; i < count; i++) {
                const powerUp = document.createElement('div');
                powerUp.className = 'powerUp';
                
                // 随机位置
                const x = Math.random() * (gameWidth - 40) + 20;
                const y = Math.random() * (gameHeight - 40) + 20;
                
                powerUp.style.left = `${x}px`;
                powerUp.style.top = `${y}px`;
                
                gameContainer.appendChild(powerUp);
                
                powerUps.push({
                    element: powerUp,
                    x: x,
                    y: y,
                    type: ['shield', 'speed', 'magnet'][Math.floor(Math.random() * 3)]
                });
            }
        }
        
        // 创建特殊球
        function createSpecialBalls(count) {
            for (let i = 0; i < count; i++) {
                const specialBall = document.createElement('div');
                specialBall.className = 'special-ball';
                
                // 随机位置
                const x = Math.random() * (gameWidth - 40) + 20;
                const y = Math.random() * (gameHeight - 40) + 20;
                
                specialBall.style.left = `${x}px`;
                specialBall.style.top = `${y}px`;
                
                gameContainer.appendChild(specialBall);
                
                specialBalls.push({
                    element: specialBall,
                    x: x,
                    y: y,
                    value: 2 + Math.floor(currentLevel / 3) // 随关卡增加价值
                });
            }
        }
        
        // 创建传送门
        function createPortals(count) {
            for (let i = 0; i < count; i++) {
                const portal = document.createElement('div');
                portal.className = 'portal';
                
                // 随机位置
                const x = Math.random() * (gameWidth - 60) + 30;
                const y = Math.random() * (gameHeight - 60) + 30;
                
                portal.style.left = `${x}px`;
                portal.style.top = `${y}px`;
                
                gameContainer.appendChild(portal);
                
                portals.push({
                    element: portal,
                    x: x,
                    y: y
                });
            }
        }
        
        // 更新玩家位置
        function updatePlayerPosition() {
            player.style.left = `${playerX}px`;
            player.style.top = `${playerY}px`;
        }
        
        // 应用效果
        function applyEffect(type, duration) {
            playerEffects[type] = true;
            
            // 添加效果类
            if (type === 'shield') player.classList.add('shield');
            if (type === 'speed') player.classList.add('speed');
            
            // 清除之前的计时器（如果存在）
            if (effectTimers[type]) {
                clearTimeout(effectTimers[type]);
            }
            
            // 设置效果持续时间
            effectTimers[type] = setTimeout(() => {
                playerEffects[type] = false;
                
                // 移除效果类
                if (type === 'shield') player.classList.remove('shield');
                if (type === 'speed') player.classList.remove('speed');
            }, duration);
        }
        
        // 检测碰撞
        function checkCollisions() {
            // 检测球碰撞
            for (let i = balls.length - 1; i >= 0; i--) {
                const ball = balls[i];
                const dx = playerX - ball.x;
                const dy = playerY - ball.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 25) { // 碰撞距离
                    if (ball.color === currentTargetColor) {
                        // 收集正确颜色的球
                        score++;
                        totalScore += currentLevel * 15; // 关卡越高得分越高
                        progressText.textContent = `${score} / ${requiredScore}`;
                        progressBar.style.width = `${(score / requiredScore) * 100}%`;
                        updateScoreDisplay();
                        
                        // 检查是否完成关卡
                        if (score >= requiredScore) {
                            completeLevel();
                            return;
                        }
                    } else {
                        // 收集错误颜色的球扣血
                        takeDamage();
                    }
                    
                    // 移除球
                    ball.element.remove();
                    balls.splice(i, 1);
                    
                    // 创建新球
                    createBalls(1);
                }
            }
            
            // 检测墙碰撞
            for (const wall of walls) {
                if (playerX + 15 > wall.x && playerX - 15 < wall.x + wall.width &&
                    playerY + 15 > wall.y && playerY - 15 < wall.y + wall.height) {
                    // 简单碰撞响应 - 将玩家推回
                    if (keys.ArrowLeft || keys.left) playerX += 5;
                    if (keys.ArrowRight || keys.right) playerX -= 5;
                    if (keys.ArrowUp || keys.up) playerY += 5;
                    if (keys.ArrowDown || keys.down) playerY -= 5;
                    updatePlayerPosition();
                }
            }
            
            // 检测敌人碰撞
            for (let i = 0; i < enemies.length; i++) {
                const enemy = enemies[i];
                const dx = playerX - enemy.x;
                const dy = playerY - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 27) { // 碰撞距离
                    if (!playerEffects.shield && enemy.isAttacking) {
                        // 被敌人攻击到
                        playerSpeed = Math.max(3, playerSpeed - 1.5);
                        setTimeout(() => {
                            playerSpeed = 5 + currentLevel * 0.3;
                        }, 3000);
                        
                        takeDamage();
                        
                        // 敌人攻击后进入冷却
                        enemy.isAttacking = false;
                        enemy.element.classList.remove('attacking');
                        enemy.attackCooldown = 2000 + Math.random() * 1000;
                        attackIndicators[i].style.display = 'none';
                    }
                }
            }
            
            // 检测能量球碰撞
            for (let i = powerUps.length - 1; i >= 0; i--) {
                const powerUp = powerUps[i];
                const dx = playerX - powerUp.x;
                const dy = playerY - powerUp.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 25) { // 碰撞距离
                    // 应用效果
                    let duration = 0;
                    switch(powerUp.type) {
                        case 'shield':
                            duration = 7000 + currentLevel * 500;
                            applyEffect('shield', duration);
                            break;
                        case 'speed':
                            duration = 5000 + currentLevel * 500;
                            applyEffect('speed', duration);
                            playerSpeed *= 1.8;
                            setTimeout(() => {
                                playerSpeed = 5 + currentLevel * 0.3;
                            }, duration);
                            break;
                        case 'magnet':
                            duration = 6000 + currentLevel * 500;
                            applyEffect('magnet', duration);
                            break;
                    }
                    
                    // 移除能量球
                    powerUp.element.remove();
                    powerUps.splice(i, 1);
                    
                    // 创建新能量球
                    setTimeout(() => {
                        createPowerUps(1);
                    }, 10000);
                }
            }
            
            // 检测特殊球碰撞
            for (let i = specialBalls.length - 1; i >= 0; i--) {
                const specialBall = specialBalls[i];
                const dx = playerX - specialBall.x;
                const dy = playerY - specialBall.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 27) { // 碰撞距离
                    score += specialBall.value;
                    totalScore += currentLevel * 40; // 特殊球得分更高
                    progressText.textContent = `${score} / ${requiredScore}`;
                    progressBar.style.width = `${(score / requiredScore) * 100}%`;
                    updateScoreDisplay();
                    
                    // 检查是否完成关卡
                    if (score >= requiredScore) {
                        completeLevel();
                        return;
                    }
                    
                    // 移除特殊球
                    specialBall.element.remove();
                    specialBalls.splice(i, 1);
                    
                    // 创建新特殊球
                    setTimeout(() => {
                        createSpecialBalls(1);
                    }, 8000);
                }
            }
            
            // 检测传送门碰撞
            for (const portal of portals) {
                const dx = playerX - portal.x;
                const dy = playerY - portal.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 30) { // 碰撞距离
                    // 传送到随机位置
                    playerX = Math.random() * (gameWidth - 60) + 30;
                    playerY = Math.random() * (gameHeight - 60) + 30;
                    updatePlayerPosition();
                    break;
                }
            }
        }
        
        // 磁铁效果 - 吸引附近的球
        function magnetEffect() {
            if (!playerEffects.magnet) return;
            
            const magnetRadius = 200;
            
            balls.forEach(ball => {
                const dx = playerX - ball.x;
                const dy = playerY - ball.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < magnetRadius && ball.color === currentTargetColor) {
                    // 计算方向
                    const angle = Math.atan2(dy, dx);
                    const speed = 4;
                    
                    // 移动球
                    ball.x += Math.cos(angle) * speed;
                    ball.y += Math.sin(angle) * speed;
                    
                    // 更新球的位置
                    ball.element.style.left = `${ball.x}px`;
                    ball.element.style.top = `${ball.y}px`;
                }
            });
        }
        
        // 移动敌人
        function moveEnemies(deltaTime) {
            enemyAttackCooldown -= deltaTime;
            
            enemies.forEach((enemy, index) => {
                // 敌人追踪玩家
                const dx = playerX - enemy.x;
                const dy = playerY - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 0) {
                    const speed = 1.5 + currentLevel * 0.2; // 敌人速度随关卡增加
                    const vx = (dx / distance) * speed;
                    const vy = (dy / distance) * speed;
                    
                    enemy.x += vx;
                    enemy.y += vy;
                }
                
                // 敌人攻击逻辑
                if (!enemy.isAttacking && enemy.attackCooldown <= 0) {
                    // 开始攻击
                    enemy.isAttacking = true;
                    enemy.element.classList.add('attacking');
                    
                    // 显示攻击指示器
                    attackIndicators[index].style.left = `${enemy.x - 6}px`;
                    attackIndicators[index].style.top = `${enemy.y - 6}px`;
                    attackIndicators[index].style.display = 'block';
                    
                    // 攻击持续时间
                    setTimeout(() => {
                        if (enemy.isAttacking) {
                            enemy.isAttacking = false;
                            enemy.element.classList.remove('attacking');
                            enemy.attackCooldown = 2000 + Math.random() * 1000;
                            attackIndicators[index].style.display = 'none';
                        }
                    }, 800);
                } else {
                    enemy.attackCooldown -= deltaTime;
                }
                
                // 确保敌人在屏幕内
                enemy.x = Math.max(15, Math.min(gameWidth - 15, enemy.x));
                enemy.y = Math.max(15, Math.min(gameHeight - 15, enemy.y));
                
                // 更新敌人位置
                enemy.element.style.left = `${enemy.x}px`;
                enemy.element.style.top = `${enemy.y}px`;
                
                // 检测敌人与墙的碰撞
                walls.forEach(wall => {
                    if (enemy.x + 12 > wall.x && enemy.x - 12 < wall.x + wall.width &&
                        enemy.y + 12 > wall.y && enemy.y - 12 < wall.y + wall.height) {
                        // 反弹
                        enemy.x -= enemy.speedX;
                        enemy.y -= enemy.speedY;
                    }
                });
            });
        }
        
        // 完成关卡
        function completeLevel() {
            clearLevel();
            levelComplete.style.display = 'block';
            
            setTimeout(() => {
                levelComplete.style.display = 'none';
                currentLevel++;
                
                if (currentLevel <= 15) { // 总共15关
                    startLevel();
                } else {
                    // 游戏完成
                    finalScoreDisplay2.textContent = totalScore;
                    finalScreen.style.display = 'flex';
                    clearInterval(timerInterval);
                }
            }, 1500);
        }
        
        // 键盘控制
        window.addEventListener('keydown', (e) => {
            if (!gameStarted) return;
            keys[e.key] = true;
            keys[e.key.toLowerCase()] = true; // 同时检测小写
        });
        
        window.addEventListener('keyup', (e) => {
            if (!gameStarted) return;
            keys[e.key] = false;
            keys[e.key.toLowerCase()] = false;
        });
        
        // 触摸控制
        upBtn.addEventListener('touchstart', (e) => {
            if (!gameStarted) return;
            e.preventDefault();
            keys.up = true;
        });
        upBtn.addEventListener('touchend', (e) => {
            if (!gameStarted) return;
            e.preventDefault();
            keys.up = false;
        });
        
        leftBtn.addEventListener('touchstart', (e) => {
            if (!gameStarted) return;
            e.preventDefault();
            keys.left = true;
        });
        leftBtn.addEventListener('touchend', (e) => {
            if (!gameStarted) return;
            e.preventDefault();
            keys.left = false;
        });
        
        downBtn.addEventListener('touchstart', (e) => {
            if (!gameStarted) return;
            e.preventDefault();
            keys.down = true;
        });
        downBtn.addEventListener('touchend', (e) => {
            if (!gameStarted) return;
            e.preventDefault();
            keys.down = false;
        });
        
        rightBtn.addEventListener('touchstart', (e) => {
            if (!gameStarted) return;
            e.preventDefault();
            keys.right = true;
        });
        rightBtn.addEventListener('touchend', (e) => {
            if (!gameStarted) return;
            e.preventDefault();
            keys.right = false;
        });
        
        // 游戏说明
        helpButton.addEventListener('click', () => {
            helpModal.style.display = 'block';
        });
        
        closeHelp.addEventListener('click', () => {
            helpModal.style.display = 'none';
        });
        
        // 窗口大小调整
        window.addEventListener('resize', () => {
            gameWidth = window.innerWidth;
            gameHeight = window.innerHeight;
        });
        
        // 重新开始按钮
        restartButton1.addEventListener('click', () => {
            gameOverScreen.style.display = 'none';
            gameStarted = true;
            initGame();
        });
        
        restartButton2.addEventListener('click', () => {
            finalScreen.style.display = 'none';
            gameStarted = true;
            initGame();
        });
        
        // 开始游戏按钮
        startButton.addEventListener('click', () => {
            welcomeModal.style.display = 'none';
            gameStarted = true;
            initGame();
        });
        
        // 游戏循环
        let lastTime = 0;
        function gameLoop(timestamp) {
            if (!gameStarted) {
                requestAnimationFrame(gameLoop);
                return;
            }
            
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            
            // 移动玩家
            if ((keys.ArrowLeft || keys.left) && playerX > 15) playerX -= playerSpeed;
            if ((keys.ArrowRight || keys.right) && playerX < gameWidth - 15) playerX += playerSpeed;
            if ((keys.ArrowUp || keys.up) && playerY > 15) playerY -= playerSpeed;
            if ((keys.ArrowDown || keys.down) && playerY < gameHeight - 15) playerY += playerSpeed;
            
            updatePlayerPosition();
            checkCollisions();
            magnetEffect();
            moveEnemies(deltaTime);
            
            requestAnimationFrame(gameLoop);
        }
        
        // 初始化游戏循环
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>